---
title: "move regression"
output: html_document
date: "2025-01-18"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

```{r read features}
bins = read_csv("~/Work/ODEA/qAlgorithms/build/22090901_H2O_1_pos_positive_bins.csv")
peaks = read_csv("~/Work/ODEA/qAlgorithms/build/22090901_H2O_1_pos_positive_features.csv")
peaks = peaks[order(peaks$retentionTime),]
```
82 + 312

```{r}
feature_A = 82
feature_B = 312

feature_A = peaks[which(peaks$ID == feature_A),]
feature_B = peaks[which(peaks$ID == feature_B),]
feature_A$rt_switch = rt_switch(feature_A)
feature_B$rt_switch = rt_switch(feature_B)

points_A = bins[which(bins$binID == feature_A$binID),]
points_B = bins[which(bins$binID == feature_B$binID),]

clamp_l = 0
clamp_r = length(points_A$binID)
if (feature_A$binIdxStart - 3 > 0)
{clamp_l = feature_A$binIdxStart - 3}
if (feature_A$binIdxEnd + 3 < clamp_r)
{clamp_r = feature_A$binIdxEnd + 3}#
points_A = points_A[clamp_l:clamp_r,]

clamp_l = 0
clamp_r = length(points_B$binID)
if (feature_B$binIdxStart - 3 > 0)
{clamp_l = feature_B$binIdxStart - 3}
if (feature_B$binIdxEnd + 3 < clamp_r)
{clamp_r = feature_B$binIdxEnd + 3}#
points_B = points_B[clamp_l:clamp_r,]

rts = (feature_A$highestRetentionTime - feature_A$lowestRetentionTime) / 100
rts = feature_A$lowestRetentionTime + 1:100 * rts
curve_A = peakShape(rts, feature_A$rt_switch, feature_A$b0, feature_A$b1, feature_A$b2, feature_A$b3)
```

```{r}
ggplot(rbind(points_A, points_B))+
  geom_point(aes(retentionTime, area, colour = binID))


```


```{r}
rt_switch = function(feature){
  div = 0
  if (feature$apexLeft){
    div = feature$b2 * 2
  } else {
    div = feature$b3 * 2
  }
  return(-feature$b1 / div)
}

peakShape = function(x, rt_switch, b0, b1, b2, b3){
  squareCoeff = (as.numeric(x < rt_switch) * b2 * x^2) 
  sq2 = (as.numeric(!(x < rt_switch)) * b3 * x^2)
  # print(squareCoeff)
  # print(sq2)
  return(exp(- (b0 + x * b1 + squareCoeff + sq2)))
}
```

